<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½é’å°‘å¹´ç¾å¼è¶³çƒçƒé˜Ÿåˆ†å¸ƒå›¾ï½œå…¨å›½ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* === çƒé˜Ÿå›¾æ ‡æ ·å¼ === */
        .team-icon {
            width: 58px;
            height: 58px;
            background: #ffffff;
            border-radius: 50%;
            border: 2px solid #3b82f6;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
            cursor: pointer;
        }
        .team-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
            border-color: #1d4ed8;
        }
        .team-icon img {
            width: 46px;
            height: 46px;
            object-fit: contain;
        }

        /* === å·¥å…·æç¤ºæ ·å¼ === */
        .leaflet-tooltip.team-tooltip {
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            padding: 6px 12px;
            margin-top: -10px;
        }
        .leaflet-tooltip-top.team-tooltip::before {
            border-top-color: rgba(255, 255, 255, 0.95);
        }

        /* === å¼¹çª—å¡ç‰‡æ ·å¼ === */
        .popup-card {
            min-width: 200px;
        }
        .popup-card h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #111827;
        }
        .popup-card p {
            margin: 5px 0;
            font-size: 14px;
            color: #4b5563;
        }
        .popup-card .city {
            color: #3b82f6;
            font-weight: 600;
        }
        .popup-card .age-group {
            color: #059669;
            font-weight: 600;
        }

        /* === è¿æ¥çº¿æ ·å¼ === */
        .city-connector {
            stroke: #94a3b8;
            stroke-width: 1.5;
            stroke-dasharray: 5, 5;
            opacity: 0.5;
            fill: none;
        }

        /* === å›¾ä¾‹æ ·å¼ === */
        #legend {
            position: absolute;
            bottom: 25px;
            right: 25px;
            background: rgba(255, 255, 255, 0.97);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e7eb;
            z-index: 1000;
            font-size: 13px;
            line-height: 1.5;
            max-width: 300px;
            backdrop-filter: blur(4px);
        }
        #legend h4 {
            margin: 0 0 12px 0;
            color: #1f2937;
            font-size: 15px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 8px;
        }
        .legend-color {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #d1d5db;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .city-highlight {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }

        /* === æ§åˆ¶é¢æ¿æ ·å¼ - å¯æŠ˜å å¼ === */
        #control-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.98);
            padding: 0;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border: 1px solid #e5e7eb;
            z-index: 1000;
            max-width: 280px;
            font-size: 13px;
            line-height: 1.5;
            max-height: none;
            overflow: visible;
            transition: all 0.3s ease;
        }

        /* æ§åˆ¶é¢æ¿æ ‡é¢˜æ ï¼ˆå¯ç‚¹å‡»æŠ˜å ï¼‰ */
        .panel-header {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 12px 12px 0 0;
        }

        .panel-header h4 {
            margin: 0;
            color: #1f2937;
            font-size: 14px;
            font-weight: 600;
        }

        .panel-toggle {
            font-size: 18px;
            color: #6b7280;
            transition: transform 0.3s ease;
        }

        .panel-toggle.collapsed {
            transform: rotate(-90deg);
        }

        /* é¢æ¿å†…å®¹åŒºåŸŸ */
        .panel-content {
            padding: 15px;
            max-height: 50vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        /* æŠ˜å çŠ¶æ€ */
        #control-panel.collapsed .panel-content {
            display: none;
        }

        #control-panel.collapsed {
            max-width: 180px;
        }

        /* åŸå¸‚ç­›é€‰å¤é€‰æ¡†åŒºåŸŸ */
        #city-filters {
            margin-bottom: 10px;
        }

        .city-checkbox {
            display: flex;
            align-items: center;
            margin: 6px 0;
            cursor: pointer;
        }
        .city-checkbox input {
            margin-right: 8px;
            cursor: pointer;
        }
        .city-checkbox label {
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 13px;
        }
        .city-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }
        #toggle-all {
            margin-top: 10px;
            padding: 8px 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
            font-weight: 600;
        }
        #toggle-all:hover {
            background: #2563eb;
        }

        /* === ç§»åŠ¨ç«¯ä¸“å±ä¼˜åŒ– === */
        @media (max-width: 768px) {
            /* åœ°å›¾å®¹å™¨ */
            #map {
                padding-top: 60px;
            }
            
            /* æ§åˆ¶é¢æ¿åœ¨ç§»åŠ¨ç«¯çš„å®šä½ */
            #control-panel {
                top: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                width: auto;
            }
            
            /* ç§»åŠ¨ç«¯é»˜è®¤æŠ˜å æ§åˆ¶é¢æ¿ */
            #control-panel.collapsed {
                max-width: none;
                width: auto;
            }
            
            #control-panel.collapsed .panel-header h4 {
                font-size: 13px;
            }
            
            /* å›¾ä¾‹åœ¨ç§»åŠ¨ç«¯ä½ç½® */
            #legend {
                bottom: 10px;
                right: 10px;
                left: 10px;
                padding: 12px;
                font-size: 12px;
                max-width: none;
                cursor: pointer;
            }
            
            /* ç§»åŠ¨ç«¯çƒé˜Ÿå›¾æ ‡ç¨å° */
            .team-icon {
                width: 48px;
                height: 48px;
            }
            
            .team-icon img {
                width: 38px;
                height: 38px;
            }
            
            /* å·¥å…·æç¤ºä¼˜åŒ– */
            .leaflet-tooltip.team-tooltip {
                font-size: 12px;
                padding: 4px 8px;
                margin-top: -8px;
            }
            
            /* å¼¹çª—ä¼˜åŒ– */
            .popup-card {
                min-width: 180px;
                font-size: 13px;
            }
            
            .popup-card h3 {
                font-size: 16px;
            }
            
            /* è¿æ¥çº¿æ›´ç»† */
            .city-connector {
                stroke-width: 1px;
            }
        }

        /* å°å±å¹•æ‰‹æœºé¢å¤–ä¼˜åŒ– */
        @media (max-width: 480px) {
            .team-icon {
                width: 44px;
                height: 44px;
                min-width: 44px;
                min-height: 44px;
            }
            
            .team-icon img {
                width: 34px;
                height: 34px;
            }
            
            #legend {
                padding: 10px;
                font-size: 11px;
            }
            
            #control-panel.collapsed {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- å¯æŠ˜å æ§åˆ¶é¢æ¿ -->
    <div id="control-panel" class="collapsed">
        <div class="panel-header">
            <h4>ğŸˆ åŸå¸‚ç­›é€‰ (16ä¸ªåŸå¸‚)</h4>
            <span class="panel-toggle">â–¼</span>
        </div>
        <div class="panel-content">
            <div id="city-filters"></div>
            <button id="toggle-all">æ˜¾ç¤º/éšè—æ‰€æœ‰</button>
            <div style="font-size:11px; color:#6b7280; margin-top:10px;">
                <p>âœ“ ç‚¹å‡»åŸå¸‚åç­›é€‰<br>âœ“ ç‚¹å‡»å›¾æ ‡æŸ¥çœ‹è¯¦æƒ…</p>
            </div>
        </div>
    </div>
    
    <!-- å›¾ä¾‹ -->
    <div id="legend"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ================= åˆå§‹åŒ–åœ°å›¾ =================
        const map = L.map('map', {
            zoomControl: true,
            preferCanvas: true
        }).setView([32.0, 110.0], 5);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap, Â© CARTO',
            maxZoom: 18,
            subdomains: 'abcd'
        }).addTo(map);

        // ================= çƒé˜Ÿ Logo æ˜ å°„ =================
        const teamLogos = {
            // å¹¿ä¸œçƒé˜Ÿ
            "å¹¿å·éª‘å£«": "logos/guangzhou-knights.png",
            "å¹¿å·ç™½é³è±š": "logos/guangzhou-dolphins.png",
            "ä½›å±±å°å…•è™": "logos/foshan-xiaoxihu.png",
            "ç æµ·æµ·ä¸œé’": "logos/zhuhai-gyrfalcon.png",
            "æ·±åœ³é²²é¹": "logos/shenzhen-kunpeng.png",
            "å¹¿å·å…«çˆªé±¼": "logos/placeholder.png",
            "æ·±åœ³çƒ­æµª": "logos/placeholder.png",
            "æ·±åœ³ç«ç®­ç†Š": "logos/placeholder.png",
            
            // ä¸Šæµ·çƒé˜Ÿ
            "ä¸Šæµ·çƒ½ç«ç‹¼": "logos/placeholder.png",
            "ä¸Šæµ·é¹°": "logos/placeholder.png",
            "ä¸Šæµ·è“é­”": "logos/placeholder.png",
            "ä¸Šæµ·Changé£“é£": "logos/placeholder.png",
            "ä¸Šæµ·é³„é±¼": "logos/placeholder.png",
            "ä¸Šæµ·é“¶æ²³": "logos/placeholder.png",
            "ä¸Šæµ·åšæ¯…å¦å…‹": "logos/placeholder.png",
            "ä¸Šæµ·AFAé²¨é±¼": "logos/placeholder.png",
            "ä¸Šæµ·é£“é£è§’æ–—å£«": "logos/placeholder.png",
            "ä¸Šæµ·å¹½çµè™": "logos/placeholder.png",
            
            // æ±Ÿè‹çƒé˜Ÿ
            "å—äº¬å¾æœè€…": "logos/placeholder.png",
            "è‹å·è“éª‘å£«": "logos/placeholder.png",
            
            // æµ™æ±Ÿçƒé˜Ÿ
            "æ­å·å°†å†›": "logos/placeholder.png",
            "æ­å·çŒ›è™": "logos/placeholder.png",
            "æ­å·å››å¶è‰": "logos/placeholder.png",
            
            // æ–°å¢çƒé˜Ÿ - é»˜è®¤ä½¿ç”¨å ä½ç¬¦
            "è¥¿å®‰ä¼ å¥‡": "logos/placeholder.png",
            "æˆéƒ½å·æ¸å¹¼å¸ˆè”é˜Ÿ": "logos/placeholder.png",
            "æˆéƒ½å¤ªé˜³é¸Ÿ": "logos/placeholder.png",
            "æˆéƒ½çº¢æ½®": "logos/placeholder.png",
            "æ­¦æ±‰changeå·´è¨å¡": "logos/placeholder.png",
            "æ­¦æ±‰changeçœ¼é•œè›‡": "logos/placeholder.png",
            "åŒ—äº¬ç»´è‚¯": "logos/placeholder.png",
            "åŒ—äº¬é»‘æ›¼å·´": "logos/placeholder.png",
            "åŒ—äº¬é›„ç‹®": "logos/placeholder.png",
            "é’å²›è™é²¸": "logos/placeholder.png",
            "æµå—çœ¼é•œè›‡": "logos/placeholder.png"
        };

        // ================= åŸå¸‚ & çƒé˜Ÿæ•°æ® =================
        const citiesData = [
            // å¹¿ä¸œåœ°åŒº
            {
                id: "guangzhou",
                name: "å¹¿å·",
                center: [23.1291, 113.2644],
                color: "#3b82f6",
                teams: [
                    { name: "å¹¿å·éª‘å£«", age: "U11 / U13" },
                    { name: "å¹¿å·ç™½é³è±š", age: "U11 / U13" },
                    { name: "å¹¿å·å…«çˆªé±¼", age: "U10" }
                ]
            },
            {
                id: "shenzhen",
                name: "æ·±åœ³",
                center: [22.5431, 114.0579],
                color: "#10b981",
                teams: [
                    { name: "æ·±åœ³é²²é¹", age: "U13" },
                    { name: "æ·±åœ³çƒ­æµª", age: "U13" },
                    { name: "æ·±åœ³ç«ç®­ç†Š", age: "U10" }
                ]
            },
            {
                id: "foshan",
                name: "ä½›å±±",
                center: [23.0215, 113.1214],
                color: "#8b5cf6",
                teams: [
                    { name: "ä½›å±±å°å…•è™", age: "U9 / U11 / U13 / U15" }
                ]
            },
            {
                id: "zhuhai",
                name: "ç æµ·",
                center: [22.2707, 113.5767],
                color: "#f59e0b",
                teams: [
                    { name: "ç æµ·æµ·ä¸œé’", age: "å¾…ç¡®è®¤" }
                ]
            },
            // ä¸Šæµ·åœ°åŒº
            {
                id: "shanghai",
                name: "ä¸Šæµ·",
                center: [31.2304, 121.4737],
                color: "#ef4444",
                teams: [
                    { name: "ä¸Šæµ·çƒ½ç«ç‹¼", age: "U9 / U11 / U13 / U15" },
                    { name: "ä¸Šæµ·é¹°", age: "U9 / U11 / U13 / U15" },
                    { name: "ä¸Šæµ·è“é­”", age: "U11 / U13" },
                    { name: "ä¸Šæµ·Changé£“é£", age: "U11" },
                    { name: "ä¸Šæµ·é³„é±¼", age: "U9 / U11 / U13" },
                    { name: "ä¸Šæµ·é“¶æ²³", age: "U9 / U11 / U13 / U15" },
                    { name: "ä¸Šæµ·åšæ¯…å¦å…‹", age: "U9 / U11" },
                    { name: "ä¸Šæµ·AFAé²¨é±¼", age: "U9 / U11 / U13" },
                    { name: "ä¸Šæµ·é£“é£è§’æ–—å£«", age: "U11" },
                    { name: "ä¸Šæµ·å¹½çµè™", age: "U9" }
                ]
            },
            // æ±Ÿè‹åœ°åŒº
            {
                id: "nanjing",
                name: "å—äº¬",
                center: [32.0603, 118.7969],
                color: "#06b6d4",
                teams: [
                    { name: "å—äº¬å¾æœè€…", age: "U11" }
                ]
            },
            {
                id: "suzhou",
                name: "è‹å·",
                center: [31.2989, 120.5853],
                color: "#ec4899",
                teams: [
                    { name: "è‹å·è“éª‘å£«", age: "U11" }
                ]
            },
            // æµ™æ±Ÿåœ°åŒº
            {
                id: "hangzhou",
                name: "æ­å·",
                center: [30.2741, 120.1551],
                color: "#84cc16",
                teams: [
                    { name: "æ­å·å°†å†›", age: "U11" },
                    { name: "æ­å·çŒ›è™", age: "U13" },
                    { name: "æ­å·å››å¶è‰", age: "å¾…ç¡®è®¤" }
                ]
            },
            // æ–°å¢ï¼šè¥¿å®‰
            {
                id: "xian",
                name: "è¥¿å®‰",
                center: [34.3416, 108.9398],
                color: "#8b5cf6",
                teams: [
                    { name: "è¥¿å®‰ä¼ å¥‡", age: "U9 / U11 / U13 / U15" }
                ]
            },
            // æ–°å¢ï¼šæˆéƒ½
            {
                id: "chengdu",
                name: "æˆéƒ½",
                center: [30.5728, 104.0668],
                color: "#f59e0b",
                teams: [
                    { name: "æˆéƒ½å·æ¸å¹¼å¸ˆè”é˜Ÿ", age: "å¾…ç¡®è®¤" },
                    { name: "æˆéƒ½å¤ªé˜³é¸Ÿ", age: "å¾…ç¡®è®¤" },
                    { name: "æˆéƒ½çº¢æ½®", age: "å¾…ç¡®è®¤" }
                ]
            },
            // æ–°å¢ï¼šæ­¦æ±‰
            {
                id: "wuhan",
                name: "æ­¦æ±‰",
                center: [30.5928, 114.3055],
                color: "#10b981",
                teams: [
                    { name: "æ­¦æ±‰changeå·´è¨å¡", age: "U9 / U11 / U13 / U15" },
                    { name: "æ­¦æ±‰changeçœ¼é•œè›‡", age: "U11" }
                ]
            },
            // æ–°å¢ï¼šåŒ—äº¬
            {
                id: "beijing",
                name: "åŒ—äº¬",
                center: [39.9042, 116.4074],
                color: "#3b82f6",
                teams: [
                    { name: "åŒ—äº¬ç»´è‚¯", age: "U13" },
                    { name: "åŒ—äº¬é»‘æ›¼å·´", age: "U9 / U11" },
                    { name: "åŒ—äº¬é›„ç‹®", age: "å¾…ç¡®è®¤" }
                ]
            },
            // æ–°å¢ï¼šé’å²›
            {
                id: "qingdao",
                name: "é’å²›",
                center: [36.0671, 120.3826],
                color: "#06b6d4",
                teams: [
                    { name: "é’å²›è™é²¸", age: "U11 / U13" }
                ]
            },
            // æ–°å¢ï¼šæµå—
            {
                id: "jinan",
                name: "æµå—",
                center: [36.6512, 117.1200],
                color: "#ec4899",
                teams: [
                    { name: "æµå—çœ¼é•œè›‡", age: "å¾…ç¡®è®¤" }
                ]
            }
        ];

        // ================= æ™ºèƒ½é˜²é‡å å¸ƒå±€ç®—æ³• =================
        function calculateTeamPositions(center, teamCount) {
            if (teamCount === 1) return [center];
            
            const positions = [];
            // æ ¹æ®çƒé˜Ÿæ•°é‡è°ƒæ•´åŸºç¡€åŠå¾„
            const baseRadius = 0.08 + (teamCount * 0.006);
            
            // æ ¹æ®ä¸åŒæ•°é‡é‡‡ç”¨ä¸åŒå¸ƒå±€
            if (teamCount === 2) {
                // ä¸¤é˜Ÿï¼šæ°´å¹³æ’åˆ—
                positions.push([center[0], center[1] - baseRadius]);
                positions.push([center[0], center[1] + baseRadius]);
            } else if (teamCount === 3) {
                // ä¸‰é˜Ÿï¼šä¸‰è§’å½¢æ’åˆ—
                for (let i = 0; i < 3; i++) {
                    const angle = (i * 120 - 90) * Math.PI / 180;
                    positions.push([
                        center[0] + baseRadius * Math.cos(angle) * 0.9,
                        center[1] + baseRadius * Math.sin(angle)
                    ]);
                }
            } else if (teamCount <= 6) {
                // 4-6é˜Ÿï¼šæ­£å¤šè¾¹å½¢æ’åˆ—
                for (let i = 0; i < teamCount; i++) {
                    const angle = (i * 360 / teamCount - 90) * Math.PI / 180;
                    positions.push([
                        center[0] + baseRadius * Math.cos(angle) * 0.9,
                        center[1] + baseRadius * Math.sin(angle)
                    ]);
                }
            } else {
                // 7é˜Ÿä»¥ä¸Šï¼šèºæ—‹æ’åˆ—ï¼ˆé€‚åˆä¸Šæµ·è¿™ç§çƒé˜Ÿå¤šçš„åŸå¸‚ï¼‰
                const goldenAngle = Math.PI * (3 - Math.sqrt(5));
                for (let i = 0; i < teamCount; i++) {
                    const theta = i * goldenAngle;
                    const radius = baseRadius * Math.sqrt(i + 1);
                    positions.push([
                        center[0] + radius * Math.cos(theta) * 1.1,
                        center[1] + radius * Math.sin(theta)
                    ]);
                }
            }
            
            return positions;
        }

        // ================= å­˜å‚¨åœ°å›¾å…ƒç´  =================
        const allMarkers = {};
        const allConnectors = {};
        const allPopups = [];

        // åˆ›å»ºé»˜è®¤å ä½ç¬¦SVG
        const placeholderSVG = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDYiIGhlaWdodD0iNDYiIHZpZXdCb3g9IjAgMCA0NiA0NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjMiIGN5PSIyMyIgcj0iMjAiIGZpbGw9IiM2QjcyODAiLz4KPGNpcmNsZSBjeD0iMjMiIGN5PSIyMyIgcj0iMTciIGZpbGw9IiNFNUU3RUIiLz4KPHBhdGggZD0iTTIzIDEyVjM0TTE0IDIzSDMyIiBzdHJva2U9IiM2QjcyODAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo=';

        // ================= æ¸²æŸ“åŸå¸‚çƒé˜Ÿ =================
        function renderCity(city, visible = true) {
            // æ¸…é™¤è¯¥åŸå¸‚ç°æœ‰çš„æ ‡è®°å’Œè¿æ¥çº¿
            if (allMarkers[city.id]) {
                allMarkers[city.id].forEach(marker => map.removeLayer(marker));
                delete allMarkers[city.id];
            }
            
            if (allConnectors[city.id]) {
                allConnectors[city.id].forEach(connector => map.removeLayer(connector));
                delete allConnectors[city.id];
            }

            if (!visible) return;

            const teamCount = city.teams.length;
            const teamPositions = calculateTeamPositions(city.center, teamCount);
            
            allMarkers[city.id] = [];
            allConnectors[city.id] = [];

            // ç»˜åˆ¶è¿æ¥çº¿ï¼ˆåªæœ‰å¤šäºä¸€ä¸ªçƒé˜Ÿæ—¶ï¼‰
            if (teamCount > 1) {
                teamPositions.forEach(position => {
                    const connector = L.polyline([city.center, position], {
                        className: 'city-connector',
                        color: city.color,
                        weight: 1.2,
                        opacity: 0.3,
                        smoothFactor: 1
                    }).addTo(map);
                    allConnectors[city.id].push(connector);
                });
            }

            // åˆ›å»ºæ¯ä¸ªçƒé˜Ÿçš„æ ‡è®°
            city.teams.forEach((team, index) => {
                const teamPosition = teamPositions[index];

                const icon = L.divIcon({
                    className: 'team-marker',
                    html: `
                        <div class="team-icon" style="border-color: ${city.color}">
                            <img src="${teamLogos[team.name] || 'logos/placeholder.png'}" 
                                 alt="${team.name} Logo" 
                                 onerror="this.src='${placeholderSVG}'">
                        </div>
                    `,
                    iconSize: [58, 58],
                    iconAnchor: [29, 29]
                });

                const marker = L.marker(teamPosition, { icon })
                    .addTo(map)
                    .bindTooltip(team.name, {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -35],
                        className: 'team-tooltip',
                        opacity: 0.95
                    })
                    .bindPopup(`
                        <div class="popup-card">
                            <h3>${team.name}</h3>
                            <p><strong>åŸå¸‚ï¼š</strong><span class="city">${city.name}</span></p>
                            <p><strong>é¡¹ç›®ï¼š</strong>ç¾å¼è¶³çƒï¼ˆè£…å¤‡ï¼‰</p>
                            <p><strong>æ¢¯é˜Ÿï¼š</strong><span class="age-group">${team.age}</span></p>
                            <p style="font-size:12px; color:#9ca3af; margin-top:10px; border-top:1px solid #e5e7eb; padding-top:8px;">
                                <em>ç‚¹å‡»åœ°å›¾å…¶ä»–åŒºåŸŸå…³é—­å¼¹çª—</em>
                            </p>
                        </div>
                    `, {
                        closeButton: true,
                        maxWidth: 300,
                        minWidth: 220,
                        autoPan: true
                    });

                allMarkers[city.id].push(marker);
                allPopups.push(marker.getPopup());

                // æ‚¬åœæ•ˆæœ
                marker.on('mouseover', function () {
                    this._icon.classList.add('city-highlight');
                });
                marker.on('mouseout', function () {
                    this._icon.classList.remove('city-highlight');
                });
            });
        }

        // ================= åˆå§‹åŒ–åŸå¸‚ç­›é€‰é¢æ¿ =================
        function initCityFilters() {
            const filtersContainer = document.getElementById('city-filters');
            
            citiesData.forEach(city => {
                const checkboxId = `city-${city.id}`;
                const checkbox = document.createElement('div');
                checkbox.className = 'city-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" checked>
                    <label for="${checkboxId}">
                        <span class="city-color" style="background-color: ${city.color}"></span>
                        ${city.name} (${city.teams.length}é˜Ÿ)
                    </label>
                `;
                
                checkbox.querySelector('input').addEventListener('change', function() {
                    renderCity(city, this.checked);
                    updateLegend();
                });
                
                filtersContainer.appendChild(checkbox);
                renderCity(city, true);
            });
        }

        // ================= åˆ›å»ºå¹¶æ›´æ–°å›¾ä¾‹ =================
        function updateLegend() {
            const visibleCities = citiesData.filter(city => {
                const checkbox = document.getElementById(`city-${city.id}`);
                return checkbox ? checkbox.checked : true;
            });
            
            const totalTeams = visibleCities.reduce((sum, city) => sum + city.teams.length, 0);
            const isMobile = window.innerWidth <= 768;

            let legendContent;
            
            if (isMobile) {
                // ç§»åŠ¨ç«¯ç®€åŒ–ç‰ˆå›¾ä¾‹
                legendContent = `
                    <h4 style="margin:0 0 8px 0; font-size:14px;">ğŸˆ ${visibleCities.length}åŸ/${totalTeams}é˜Ÿ</h4>
                    <div style="font-size:12px; color:#6b7280; line-height:1.4;">
                        <p>ç‚¹å‡»ä¸Šæ–¹<b style="color:#3b82f6; margin:0 3px;">â–¼</b>ç­›é€‰åŸå¸‚</p>
                        <p>ç‚¹å‡»çƒé˜Ÿå›¾æ ‡æŸ¥çœ‹è¯¦æƒ…</p>
                        <p style="margin-top:6px; font-size:11px; color:#9ca3af;">ç‚¹å‡»æ­¤å¤„å±•å¼€å®Œæ•´å›¾ä¾‹</p>
                    </div>
                `;
            } else {
                // æ¡Œé¢ç«¯å®Œæ•´å›¾ä¾‹
                legendContent = `
                    <h4>ğŸˆ é’å°‘å¹´è£…å¤‡æ©„æ¦„çƒåˆ†å¸ƒå›¾</h4>
                    <p><strong>æ˜¾ç¤ºåŸå¸‚ï¼š</strong>${visibleCities.length} / ${citiesData.length} ä¸ª</p>
                    <p><strong>æ˜¾ç¤ºçƒé˜Ÿï¼š</strong>${totalTeams} æ”¯</p>
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e5e7eb;">
                        <p style="margin-bottom:8px; font-weight:600;">é¢œè‰²å¯¹åº”ï¼š</p>
                `;
                
                // åªæ˜¾ç¤ºå½“å‰å¯è§çš„åŸå¸‚
                visibleCities.slice(0, 8).forEach(city => {
                    legendContent += `
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: ${city.color}"></span>
                            <span>${city.name} (${city.teams.length}é˜Ÿ)</span>
                        </div>
                    `;
                });

                if (visibleCities.length > 8) {
                    legendContent += `<div class="legend-item"><span>... åŠå…¶ä»– ${visibleCities.length - 8} ä¸ªåŸå¸‚</span></div>`;
                }

                legendContent += `
                    </div>
                    <p style="font-size:12px; color:#6b7280; margin-top:12px; line-height:1.4;">
                        <strong>äº¤äº’æç¤ºï¼š</strong>é¼ æ ‡æ‚¬åœæ˜¾ç¤ºé˜Ÿåï¼Œç‚¹å‡»å›¾æ ‡æŸ¥çœ‹è¯¦æƒ…ï¼Œç‚¹å‡»åœ°å›¾ç©ºç™½å¤„å…³é—­å¼¹çª—ã€‚
                    </p>
                `;
            }

            document.getElementById('legend').innerHTML = legendContent;
            
            // ç§»åŠ¨ç«¯å›¾ä¾‹ç‚¹å‡»å±•å¼€åŠŸèƒ½
            if (isMobile) {
                const legend = document.getElementById('legend');
                const originalContent = legend.innerHTML;
                
                legend.addEventListener('click', function() {
                    if (this.getAttribute('data-expanded') === 'true') {
                        this.innerHTML = originalContent;
                        this.setAttribute('data-expanded', 'false');
                    } else {
                        // åˆ›å»ºå±•å¼€çš„å›¾ä¾‹å†…å®¹
                        let expandedContent = `
                            <h4 style="margin:0 0 10px 0; font-size:14px;">ğŸˆ å®Œæ•´å›¾ä¾‹</h4>
                            <p><strong>æ˜¾ç¤ºåŸå¸‚ï¼š</strong>${visibleCities.length} / ${citiesData.length} ä¸ª</p>
                            <p><strong>æ˜¾ç¤ºçƒé˜Ÿï¼š</strong>${totalTeams} æ”¯</p>
                            <div style="margin-top:10px; padding-top:10px; border-top:1px solid #e5e7eb;">
                                <p style="margin-bottom:6px; font-weight:600;">åŸå¸‚åˆ—è¡¨ï¼š</p>
                        `;
                        
                        visibleCities.forEach(city => {
                            expandedContent += `
                                <div class="legend-item" style="margin:4px 0;">
                                    <span class="legend-color" style="background-color: ${city.color}"></span>
                                    <span style="font-size:11px;">${city.name} (${city.teams.length}é˜Ÿ)</span>
                                </div>
                            `;
                        });
                        
                        expandedContent += `
                            </div>
                            <p style="font-size:11px; color:#6b7280; margin-top:10px; line-height:1.4;">
                                <strong>æ“ä½œæŒ‡å—ï¼š</strong><br>
                                â€¢ ç‚¹å‡»é¡¶éƒ¨é¢æ¿ç­›é€‰åŸå¸‚<br>
                                â€¢ ç‚¹å‡»çƒé˜Ÿå›¾æ ‡æŸ¥çœ‹è¯¦æƒ…<br>
                                â€¢ ç‚¹å‡»åœ°å›¾å…³é—­å¼¹çª—<br>
                                â€¢ åŒå‡»åœ°å›¾ç¼©æ”¾
                            </p>
                            <p style="font-size:10px; color:#9ca3af; margin-top:8px; text-align:center;">
                                ç‚¹å‡»æ­¤å¤„æ”¶èµ·å›¾ä¾‹
                            </p>
                        `;
                        
                        this.innerHTML = expandedContent;
                        this.setAttribute('data-expanded', 'true');
                    }
                });
                
                legend.setAttribute('data-expanded', 'false');
            }
        }

        // ================= ç§»åŠ¨ç«¯ä¼˜åŒ–åŠŸèƒ½ =================
        function initMobileOptimizations() {
            const controlPanel = document.getElementById('control-panel');
            const panelHeader = document.querySelector('.panel-header');
            const panelToggle = document.querySelector('.panel-toggle');
            
            // 1. æ§åˆ¶é¢æ¿æŠ˜å /å±•å¼€åŠŸèƒ½
            if (panelHeader) {
                panelHeader.addEventListener('click', function() {
                    controlPanel.classList.toggle('collapsed');
                    panelToggle.classList.toggle('collapsed');
                });
            }
            
            // 2. ç§»åŠ¨ç«¯é»˜è®¤æŠ˜å æ§åˆ¶é¢æ¿
            if (window.innerWidth <= 768) {
                controlPanel.classList.add('collapsed');
                if (panelToggle) panelToggle.classList.add('collapsed');
            }
            
            // 3. ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ–
            if ('ontouchstart' in window) {
                // å¢åŠ è§¦æ‘¸ç›®æ ‡å¤§å°
                const teamIcons = document.querySelectorAll('.team-icon');
                teamIcons.forEach(icon => {
                    icon.style.minWidth = '44px';
                    icon.style.minHeight = '44px';
                });
                
                // ä¼˜åŒ–å¼¹çª—å…³é—­æŒ‰é’®
                L.popup().options.closeButton = true;
                L.popup().options.closeOnClick = false;
            }
        }

        // ================= åˆå§‹åŒ– =================
        document.addEventListener('DOMContentLoaded', function() {
            initCityFilters();
            updateLegend();
            initMobileOptimizations();

            // æ›´æ–°æ§åˆ¶é¢æ¿æ ‡é¢˜
            document.querySelector('#control-panel h4').textContent = `ğŸˆ åŸå¸‚ç­›é€‰ (${citiesData.length}ä¸ªåŸå¸‚)`;

            // æ·»åŠ æ˜¾ç¤º/éšè—æ‰€æœ‰æŒ‰é’®åŠŸèƒ½
            document.getElementById('toggle-all').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('#city-filters input[type="checkbox"]');
                const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allChecked;
                    const cityId = checkbox.id.replace('city-', '');
                    const city = citiesData.find(c => c.id === cityId);
                    if (city) renderCity(city, !allChecked);
                });
                
                updateLegend();
            });

            // åœ°å›¾ç‚¹å‡»å…³é—­æ‰€æœ‰å¼¹çª—
            map.on('click', function (e) {
                allPopups.forEach(popup => {
                    if (popup && popup.isOpen()) {
                        map.closePopup(popup);
                    }
                });
            });

            // æ§åˆ¶å°ä¿¡æ¯
            console.log(`ğŸˆ é’å°‘å¹´è£…å¤‡æ©„æ¦„çƒåœ°å›¾å·²åŠ è½½ï¼`);
            console.log(`   åŸå¸‚æ•°é‡: ${citiesData.length}`);
            const totalTeams = citiesData.reduce((sum, city) => sum + city.teams.length, 0);
            console.log(`   çƒé˜Ÿæ€»æ•°: ${totalTeams}`);
            console.log(`   ç§»åŠ¨ç«¯ä¼˜åŒ–: å·²å¯ç”¨`);
        });

        // ================= çª—å£å¤§å°è°ƒæ•´å¤„ç† =================
        window.addEventListener('resize', function() {
            updateLegend();
            
            const controlPanel = document.getElementById('control-panel');
            const panelToggle = document.querySelector('.panel-toggle');
            
            // ç§»åŠ¨ç«¯/æ¡Œé¢ç«¯åˆ‡æ¢æ—¶è°ƒæ•´æ§åˆ¶é¢æ¿çŠ¶æ€
            if (window.innerWidth <= 768) {
                controlPanel.classList.add('collapsed');
                if (panelToggle) panelToggle.classList.add('collapsed');
            } else {
                controlPanel.classList.remove('collapsed');
                if (panelToggle) panelToggle.classList.remove('collapsed');
            }
        });
    </script>
</body>
</html>